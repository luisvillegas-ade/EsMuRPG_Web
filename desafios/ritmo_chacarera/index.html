<!doctype html>
<html lang="es" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Taller de Chacarera</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');
    * { font-family: 'Fredoka', sans-serif; user-select: none; -webkit-user-select: none; touch-action: manipulation; }
    
    body { 
      background-color: #1a120b; /* Marr√≥n oscuro tierra */
      color: #fcd34d; 
      margin: 0; 
      overflow: hidden; 
      height: 100vh; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
    }

    .staff-line { background: #78350f; height: 3px; }
    
    .beat-indicator { 
      transition: left 0.1s linear; 
      box-shadow: 0 0 15px #f59e0b;
      width: 4px; border-radius: 4px; background: white;
    }
    
    .hit-animation { animation: boom 0.2s ease-out; }
    @keyframes boom { 
      0% { transform: scale(1); filter: brightness(2); } 
      50% { transform: scale(1.4); } 
      100% { transform: scale(1); } 
    }

    /* ESTILO DEL BOT√ìN M√ìVIL */
    #mobile-controls {
        display: none; /* Se activa con JS si es m√≥vil */
        position: fixed;
        bottom: 20px;
        left: 0;
        width: 100%;
        justify-content: center;
        z-index: 100;
    }
    
    #btn-hit {
        background: linear-gradient(to bottom, #f59e0b, #d97706);
        border: 4px solid #fffbeb;
        color: white;
        font-size: 24px;
        font-weight: 900;
        padding: 20px 60px;
        border-radius: 50px;
        box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        text-shadow: 0 2px 2px rgba(0,0,0,0.3);
    }
    #btn-hit:active { transform: scale(0.95); box-shadow: 0 5px 10px rgba(0,0,0,0.5); }
  </style>
</head>
<body>

  <div id="app-container" class="w-full max-w-2xl bg-orange-950/90 rounded-3xl border-4 border-orange-600 shadow-2xl p-6 relative flex flex-col justify-between" style="height: 80vh; max-height: 500px;">
    
    <button id="btn-cancelar" class="absolute -top-4 -right-4 bg-red-600 hover:bg-red-500 text-white w-12 h-12 rounded-full font-bold shadow-lg border-2 border-white z-50 text-xl">X</button>

    <!-- Header -->
    <div class="flex justify-between items-center mb-2">
      <div class="flex gap-3">
        <div class="bg-black/40 px-4 py-2 rounded-xl border border-orange-500 text-center">
          <span class="text-orange-400 text-[10px] uppercase block">Aciertos</span>
          <span id="score" class="text-xl font-bold">0</span>
        </div>
        <div class="bg-black/40 px-4 py-2 rounded-xl border border-orange-500 text-center">
          <span class="text-orange-400 text-[10px] uppercase block">Compases</span>
          <span class="text-xl font-bold"><span id="measure-count">0</span><span class="text-xs">/8</span></span>
        </div>
      </div>
      <button id="start-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg border-b-4 border-green-800 active:border-b-0 active:translate-y-1 transition-all">
        ‚ñ∂Ô∏è TOCAR
      </button>
    </div>

    <!-- Pentagrama -->
    <div class="relative bg-orange-100/10 rounded-2xl p-4 border-2 border-orange-500/30 flex-grow flex items-center justify-center">
      <div class="flex items-center w-full relative">
        <div class="flex flex-col items-center justify-center mr-6 font-black text-4xl text-orange-400 leading-none">
          <span>3</span><span class="border-t-4 border-orange-400 w-full my-1 rounded"></span><span>4</span>
        </div>

        <div class="flex-1 relative h-32 flex items-center">
          <div class="absolute w-full top-4 staff-line"></div>
          <div class="absolute w-full top-12 staff-line"></div>
          <div class="absolute w-full top-20 staff-line"></div>
          <div class="absolute w-full top-28 staff-line"></div>
          
          <div id="notes-container" class="absolute inset-0 flex justify-around items-center w-full">
            <!-- T1: Silencio -->
            <div class="flex flex-col items-center opacity-50" id="slot-0">
              <div class="text-6xl text-orange-200">ùÑΩ</div>
              <span class="text-[10px] font-bold mt-2">ESPERA</span>
            </div>
            <!-- T2: Golpe -->
            <div class="flex flex-col items-center" id="slot-1">
              <div class="relative">
                  <div class="w-1.5 h-16 bg-orange-500 absolute left-3 -top-12"></div>
                  <div class="w-8 h-6 bg-orange-500 rounded-[50%] -rotate-12 head shadow-[0_0_10px_orange]"></div>
              </div>
              <span class="text-[10px] font-bold mt-2 text-orange-400">GOLPE</span>
            </div>
            <!-- T3: Golpe -->
            <div class="flex flex-col items-center" id="slot-2">
              <div class="relative">
                  <div class="w-1.5 h-16 bg-orange-500 absolute left-3 -top-12"></div>
                  <div class="w-8 h-6 bg-orange-500 rounded-[50%] -rotate-12 head shadow-[0_0_10px_orange]"></div>
              </div>
              <span class="text-[10px] font-bold mt-2 text-orange-400">GOLPE</span>
            </div>
          </div>
          <div id="beat-indicator" class="absolute top-0 h-full opacity-0"></div>
        </div>
      </div>
    </div>

    <!-- Feedback -->
    <div id="feedback" class="text-center h-8 text-2xl font-black text-yellow-400 drop-shadow-md mt-2">
      ¬°CHACARERA!
    </div>

    <!-- BOT√ìN M√ìVIL -->
    <div id="mobile-controls">
        <button id="btn-hit">ü•Å GOLPE</button>
    </div>

    <!-- Modal Victoria -->
    <div id="victory-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;">
      <div class="bg-orange-950 border-4 border-orange-400 p-8 rounded-3xl text-center max-w-xs">
        <div class="text-6xl mb-4">‚≠ê</div>
        <h2 class="text-2xl font-bold text-white mb-2">¬°MUY BIEN!</h2>
        <p class="text-orange-200 mb-6">Has completado la base.</p>
        <button id="continue-btn" class="w-full bg-green-600 text-white font-bold py-4 rounded-xl text-lg">FINALIZAR ‚û°Ô∏è</button>
      </div>
    </div>

  </div>

  <script>
    let isPlaying = false, score = 0, measureCount = 0, currentBeat = 0, tempo = 105;
    let audioCtx = null, lastBeatTime = 0, userHits = [false, false, false];
    
    // DETECTAR M√ìVIL Y MOSTRAR BOT√ìN
    if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
        document.getElementById('mobile-controls').style.display = 'flex';
    }

    function initAudio() {
        if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }
    
    function playBombo() {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.setValueAtTime(100, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.2);
      gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.25);
    }

    function playClick(high) {
      if (!audioCtx) return;
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.frequency.value = high ? 800 : 400;
      gain.gain.value = 0.05;
      osc.connect(gain); gain.connect(audioCtx.destination);
      osc.start(); osc.stop(audioCtx.currentTime + 0.05);
    }

    function runLoop() {
      if (!isPlaying) return;
      lastBeatTime = Date.now();
      playClick(currentBeat === 0);

      const positions = [16, 50, 83];
      document.getElementById('beat-indicator').style.left = positions[currentBeat] + "%";
      document.getElementById('beat-indicator').style.opacity = 1;

      for(let i=0; i<3; i++) {
          const slot = document.getElementById(`slot-${i}`);
          slot.style.opacity = (i === currentBeat) ? "1" : "0.4";
          slot.style.transform = (i === currentBeat) ? "scale(1.1)" : "scale(1)";
      }

      setTimeout(() => {
        if (!isPlaying) return;
        if (currentBeat === 2) { evaluarCompas(); currentBeat = 0; } 
        else { currentBeat++; }
        runLoop();
      }, 60000 / tempo);
    }

    function handleInput(e) {
      if (!isPlaying) return;
      if (e.type === 'keydown' && e.code !== 'Space') return;
      if (e.type === 'keydown') e.preventDefault();
      
      initAudio(); // Importante para m√≥vil

      const diff = Math.abs(Date.now() - lastBeatTime);
      const tolerance = (60000 / tempo) * 0.45;

      if (diff < tolerance) {
        if (currentBeat === 0) {
           document.getElementById('feedback').textContent = "¬°ESPERA! ‚úã";
           document.getElementById('feedback').style.color = "#ef4444";
        } else if (!userHits[currentBeat]) {
           userHits[currentBeat] = true;
           playBombo();
           score += 50;
           document.getElementById('score').textContent = score;
           document.getElementById('feedback').textContent = "¬°BOMBO! ü•Å";
           document.getElementById('feedback').style.color = "#fcd34d";
           
           const head = document.querySelector(`#slot-${currentBeat} .head`);
           head.classList.add('hit-animation');
           setTimeout(() => head.classList.remove('hit-animation'), 200);
        }
      }
    }

    function evaluarCompas() {
      if (userHits[1] && userHits[2]) {
        measureCount++;
        document.getElementById('measure-count').textContent = measureCount;
        if (measureCount >= 8) {
          isPlaying = false;
          document.getElementById('victory-modal').style.display = 'flex';
        }
      }
      userHits = [false, false, false];
    }

    document.getElementById('start-btn').onclick = (e) => {
      initAudio();
      if (isPlaying) { location.reload(); }
      else { 
        isPlaying = true; 
        e.target.textContent = "REINICIAR";
        e.target.classList.replace('bg-green-600', 'bg-slate-600');
        runLoop(); 
      }
    };

    // Eventos
    window.addEventListener('keydown', handleInput);
    
    // Bot√≥n T√°ctil
    const btnHit = document.getElementById('btn-hit');
    btnHit.addEventListener('touchstart', (e) => {
        e.preventDefault(); 
        handleInput(e);
        btnHit.style.transform = "scale(0.9)";
        setTimeout(() => btnHit.style.transform = "scale(1)", 100);
    }, {passive: false});

    document.getElementById('btn-cancelar').onclick = () => {
       if(confirm("¬øSalir?")) {
          if (window.parent) window.parent.postMessage({ tipo: "CANCELAR_DESAFIO" }, "*");
       }
    };

    document.getElementById('continue-btn').onclick = () => {
      if (window.parent) {
         window.parent.postMessage({ tipo: "FIN_DESAFIO", puntaje: score, id: "chacarera" }, "*");
      }
    };
  </script>
</body>
</html>