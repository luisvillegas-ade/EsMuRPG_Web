<!doctype html>
<html lang="es" class="h-full">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Taller de Chacarera</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;700&display=swap');

    * {
      font-family: 'Fredoka', sans-serif;
      user-select: none;
      -webkit-user-select: none;
    }

    /* Estilo Cyber-Folklore: Azul Noche y Dorado */
    body {
      background-color: #0f172a;
      /* Slate 900 */
      color: #fbbf24;
      /* Amber 400 */
      margin: 0;
      overflow: hidden;
      height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .staff-line {
      background: #475569;
      height: 2px;
    }

    /* Slate 600 */

    .beat-indicator {
      transition: left 0.1s linear;
      box-shadow: 0 0 10px #fbbf24;
    }

    .hit-animation {
      animation: boom 0.2s ease-out;
    }

    @keyframes boom {
      0% {
        transform: scale(1);
        filter: brightness(2);
      }

      100% {
        transform: scale(1);
        filter: brightness(1);
      }
    }

    /* Bot√≥n t√°ctil mejorado */
    #touch-area {
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>

<body>

  <!-- Contenedor Principal Estilo "Tarjeta/Libro" -->
  <div id="app-container"
    class="w-full max-w-2xl bg-slate-800 rounded-3xl border-2 border-amber-500 shadow-2xl p-6 relative flex flex-col justify-between"
    style="min-height: 320px;">

    <!-- Bot√≥n Salir -->
    <button id="btn-cancelar"
      class="absolute -top-3 -right-3 bg-red-600 hover:bg-red-500 text-white w-10 h-10 rounded-full font-bold shadow-lg border-2 border-white z-50">X</button>

    <!-- Header: Marcadores -->
    <div class="flex justify-between items-center mb-4">
      <div class="flex gap-3">
        <div class="bg-slate-900/50 px-4 py-2 rounded-xl border border-amber-500/30 text-center">
          <span class="text-amber-500/70 text-[10px] uppercase block tracking-widest">Puntos</span>
          <span id="score" class="text-xl font-bold text-amber-300">0</span>
        </div>
        <div class="bg-slate-900/50 px-4 py-2 rounded-xl border border-amber-500/30 text-center">
          <span class="text-amber-500/70 text-[10px] uppercase block tracking-widest">Compases</span>
          <span id="measure-count" class="text-xl font-bold text-amber-300">0</span><span
            class="text-xs text-amber-600">/8</span>
        </div>
      </div>

      <!-- Bot√≥n Iniciar (Grande) -->
      <button id="start-btn"
        class="bg-gradient-to-r from-emerald-600 to-green-600 text-white font-bold py-2 px-6 rounded-xl shadow-lg active:scale-95 transition-transform border border-green-400">
        ‚ñ∂Ô∏è INICIAR
      </button>
    </div>

    <!-- PENTAGRAMA 3/4 (Visualizaci√≥n limpia) -->
    <div class="relative bg-slate-900/40 rounded-2xl p-6 border border-amber-500/20 mb-2 flex-grow flex items-center">
      <div class="flex items-center w-full">
        <!-- Cifra -->
        <div
          class="flex flex-col items-center justify-center mr-6 font-black text-3xl text-amber-500 leading-none opacity-80">
          <span>3</span><span class="border-t-2 border-amber-500 w-full my-1"></span><span>4</span>
        </div>

        <div class="flex-1 relative h-28 flex items-center">
          <!-- L√≠neas -->
          <div class="absolute w-full top-2 staff-line"></div>
          <div class="absolute w-full top-10 staff-line"></div>
          <div class="absolute w-full top-18 staff-line"></div>
          <div class="absolute w-full top-26 staff-line"></div>

          <!-- NOTAS -->
          <div id="notes-container" class="absolute inset-0 flex justify-around items-center w-full">
            <!-- T1: Silencio -->
            <div class="flex flex-col items-center opacity-30 transition-opacity duration-200" id="slot-0">
              <div class="text-5xl">ùÑΩ</div>
              <span class="text-[9px] font-bold tracking-widest mt-2">ESPERA</span>
            </div>
            <!-- T2: Golpe -->
            <div class="flex flex-col items-center transition-opacity duration-200" id="slot-1">
              <div class="relative">
                <div class="w-1 h-14 bg-amber-500 absolute left-4 -top-12"></div>
                <div class="w-8 h-6 bg-amber-500 rounded-[50%] -rotate-12 head shadow-[0_0_10px_rgba(251,191,36,0.3)]">
                </div>
              </div>
              <span class="text-[9px] font-bold tracking-widest mt-2 text-amber-400">GOLPE</span>
            </div>
            <!-- T3: Golpe -->
            <div class="flex flex-col items-center transition-opacity duration-200" id="slot-2">
              <div class="relative">
                <div class="w-1 h-14 bg-amber-500 absolute left-4 -top-12"></div>
                <div class="w-8 h-6 bg-amber-500 rounded-[50%] -rotate-12 head shadow-[0_0_10px_rgba(251,191,36,0.3)]">
                </div>
              </div>
              <span class="text-[9px] font-bold tracking-widest mt-2 text-amber-400">GOLPE</span>
            </div>
          </div>

          <!-- Cursor -->
          <div id="beat-indicator"
            class="absolute top-0 w-1 h-full bg-amber-300 rounded-full opacity-0 shadow-[0_0_15px_white]"></div>
        </div>
      </div>
    </div>

    <!-- Feedback Texto -->
    <div id="feedback" class="text-center h-8 text-xl font-bold text-amber-300 tracking-widest drop-shadow-md">
      RITMO DE CHACARERA
    </div>

    <!-- Bot√≥n Gigante Invisible para M√≥vil (Mejor UX que un bot√≥n chiquito) -->
    <div id="touch-area"
      class="md:hidden fixed inset-x-0 bottom-0 h-1/3 z-40 bg-gradient-to-t from-amber-900/30 to-transparent flex items-end justify-center pb-6">
      <span class="text-amber-200/50 font-bold animate-pulse text-sm">TOCA AQU√ç (BOMBO)</span>
    </div>

    <!-- Modal Victoria -->
    <div id="victory-modal"
      style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.95); z-index: 10000; align-items: center; justify-content: center;">
      <div
        class="bg-slate-800 border-2 border-amber-400 rounded-2xl p-8 text-center max-w-xs shadow-2xl relative overflow-hidden">
        <!-- Brillo de fondo -->
        <div class="absolute inset-0 bg-amber-500/10"></div>

        <div class="relative z-10">
          <div class="text-6xl mb-4 animate-bounce">ü•Å</div>
          <h2 class="text-2xl font-black text-amber-400 mb-2 uppercase tracking-wider">¬°Excelente!</h2>
          <p class="text-slate-300 mb-6 text-sm leading-relaxed">El ritmo de la tierra fluye en tus manos. Has
            completado la lecci√≥n.</p>
          <button id="continue-btn"
            class="w-full bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-3 rounded-xl shadow-lg transition-all border-b-4 border-emerald-800 active:border-b-0 active:translate-y-1">
            CONTINUAR ‚û°Ô∏è
          </button>
        </div>
      </div>
    </div>

  </div>

  <script>
    // --- L√ìGICA DE SISTEMAS ---
    let isPlaying = false;
    let score = 0;
    let measureCount = 0;
    let currentBeat = 0;
    let tempo = 105;
    let audioCtx = null;
    let lastBeatTime = 0;
    let userHits = [false, false, false];
    let audioUnlocked = false; // Flag para m√≥viles

    // Inicializador de Audio Robusto (Mobile Friendly)
    function unlockAudio() {
      if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      }
      if (audioCtx.state === 'suspended') {
        audioCtx.resume();
      }
      audioUnlocked = true;
    }

    // Sintetizador Simple (Sin cargar archivos para velocidad)
    function playSound(type) {
      if (!audioCtx) return;

      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      if (type === 'click') { // Metr√≥nomo
        osc.frequency.setValueAtTime(currentBeat === 0 ? 1000 : 600, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.05);
      } else { // Bombo
        osc.frequency.setValueAtTime(100, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(30, audioCtx.currentTime + 0.2);
        gain.gain.setValueAtTime(0.6, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      }

      osc.connect(gain);
      gain.connect(audioCtx.destination);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.25);
    }

    // Bucle del Juego
    function runLoop() {
      if (!isPlaying) return;

      lastBeatTime = Date.now();
      playSound('click'); // Sonido autom√°tico de gu√≠a

      // Visuales
      const positions = [16, 50, 83];
      const indicator = document.getElementById('beat-indicator');
      indicator.style.left = positions[currentBeat] + "%";
      indicator.style.opacity = 1;

      // Resaltar nota activa
      for (let i = 0; i < 3; i++) {
        const slot = document.getElementById(`slot-${i}`);
        if (i === currentBeat) {
          slot.style.opacity = "1";
          slot.style.transform = "scale(1.1)";
        } else {
          slot.style.opacity = "0.4";
          slot.style.transform = "scale(1)";
        }
      }

      setTimeout(() => {
        if (!isPlaying) return;
        if (currentBeat === 2) {
          evaluarCompas();
          currentBeat = 0;
        } else {
          currentBeat++;
        }
        runLoop();
      }, 60000 / tempo);
    }

    // Manejo de Input (Unificado para Teclado y Touch)
    function handleInput(e) {
      if (!isPlaying) return;
      if (e.type === 'keydown' && e.code !== 'Space') return;
      if (e.type === 'keydown') e.preventDefault(); // Evitar scroll con espacio

      // Desbloquear audio si es la primera vez en m√≥vil
      if (!audioUnlocked) unlockAudio();

      // Calcular precisi√≥n
      const diff = Math.abs(Date.now() - lastBeatTime);
      const tolerance = (60000 / tempo) * 0.45; // Tolerancia amplia

      if (diff < tolerance) {
        // L√≥gica de Chacarera: Silencio (0) - Golpe (1) - Golpe (2)
        if (currentBeat === 0) {
          // Error: Toc√≥ en el silencio
          feedback("¬°ESPERA! ‚úã", "#ef4444");
        } else if (!userHits[currentBeat]) {
          // Acierto
          userHits[currentBeat] = true;
          score += 50;
          document.getElementById('score').textContent = score;
          feedback("¬°BIEN! ü•Å", "#fbbf24");
          playSound('drum');

          // Animaci√≥n de la nota
          const head = document.querySelector(`#slot-${currentBeat} .head`);
          if (head) {
            head.classList.add('hit-animation');
            setTimeout(() => head.classList.remove('hit-animation'), 200);
          }
        }
      }
    }

    function feedback(text, color) {
      const el = document.getElementById('feedback');
      el.textContent = text;
      el.style.color = color;
      el.style.transform = "scale(1.2)";
      setTimeout(() => el.style.transform = "scale(1)", 100);
    }

    function evaluarCompas() {
      // Para ganar el comp√°s: Tiempos 1 y 2 deben estar golpeados.
      if (userHits[1] && userHits[2]) {
        measureCount++;
        document.getElementById('measure-count').textContent = measureCount;

        // Dificultad progresiva: Acelerar un poquito
        if (measureCount === 4) tempo += 5;

        if (measureCount >= 8) {
          finishGame();
        }
      }
      userHits = [false, false, false];
    }

    function finishGame() {
      isPlaying = false;
      document.getElementById('victory-modal').style.display = 'flex';
    }

    // --- EVENTOS ---

    // Iniciar
    document.getElementById('start-btn').addEventListener('click', (e) => {
      unlockAudio(); // Clave para iOS/Android
      if (isPlaying) {
        location.reload();
      } else {
        isPlaying = true;
        e.target.textContent = "REINICIAR";
        e.target.classList.remove('from-emerald-600', 'to-green-600');
        e.target.classList.add('bg-slate-700');
        runLoop();
      }
    });

    // Inputs
    window.addEventListener('keydown', handleInput);

    // Bot√≥n T√°ctil (Zona inferior de la pantalla)
    const touchArea = document.getElementById('touch-area');
    touchArea.addEventListener('touchstart', (e) => {
      e.preventDefault(); // Evitar zoom o scroll
      handleInput(e);
    }, { passive: false });

    // Salida
    document.getElementById('btn-cancelar').onclick = () => {
      if (confirm("¬øSalir de la pr√°ctica?")) {
        if (window.parent) window.parent.postMessage({ tipo: "CANCELAR_DESAFIO" }, "*");
      }
    };

    document.getElementById('continue-btn').onclick = () => {
      if (window.parent) {
        window.parent.postMessage({ tipo: "FIN_DESAFIO", puntaje: score, id: "chacarera" }, "*");
      }
    };
  </script>
</body>

</html>