<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laboratorio: El Pulso de la Tierra - EsMuRPG</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        base: '#0d1117',
                        card: '#161b22',
                        border: '#30363d',
                        amber: '#fbbf24',
                        terracotta: '#ea580c',
                        textMuted: '#c9d1d9'
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    animation: {
                        'pulse-beat': 'beat 0.3s ease-out',
                    },
                    keyframes: {
                        beat: {
                            '0%': { transform: 'scale(1)', boxShadow: '0 0 0 rgba(234, 88, 12, 0)' },
                            '50%': { transform: 'scale(1.15)', boxShadow: '0 0 40px rgba(234, 88, 12, 0.6)' },
                            '100%': { transform: 'scale(1)', boxShadow: '0 0 0 rgba(234, 88, 12, 0)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            background-color: #0d1117;
            color: #c9d1d9;
            font-family: 'Inter', sans-serif;
        }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 24px;
            width: 24px;
            border-radius: 50%;
            background: #fbbf24;
            cursor: pointer;
            margin-top: -10px;
            box-shadow: 0 0 10px rgba(251, 191, 36, 0.5);
            transition: transform 0.1s;
        }

        input[type=range]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 6px;
            cursor: pointer;
            background: #30363d;
            border-radius: 3px;
        }

        input[type=range]:focus {
            outline: none;
        }
    </style>
</head>

<body
    class="min-h-screen p-4 md:p-8 antialiased flex flex-col items-center selection:bg-terracotta selection:text-white">

    <main class="max-w-3xl w-full mx-auto mt-4 space-y-6">

        <!-- HEADER -->
        <header class="flex items-center justify-between pb-4 border-b border-border">
            <a href="../temario.html"
                class="flex items-center gap-2 text-textMuted hover:text-amber transition-colors font-medium">
                <i class="ph ph-arrow-left text-xl"></i>
                <span class="hidden sm:inline">Volver al Temario</span>
            </a>
            <h1 class="text-xl md:text-2xl font-bold text-white tracking-tight flex items-center gap-3">
                <i class="ph-fill ph-flask text-cyan-400"></i>
                Laboratorio: El Pulso de la Tierra
            </h1>
        </header>

        <!-- EXPLICACIÓN PEDAGÓGICA -->
        <section class="bg-card border border-border rounded-xl p-6 shadow-lg relative overflow-hidden">
            <div class="absolute top-0 left-0 w-1 h-full bg-cyan-500"></div>
            <h2 class="text-white font-semibold mb-2 flex items-center gap-2">
                <i class="ph ph-info text-cyan-400 text-lg"></i> ¿Qué es el pulso?
            </h2>
            <p class="text-sm md:text-base leading-relaxed text-textMuted">
                El pulso es la unidad básica para medir el tiempo en la música. Es como tu latido: constante, regular y
                no se detiene. Mueve el control para sentir cómo un pulso más rápido cambia la energía de la música.
            </p>
        </section>

        <!-- ÁREA VISUAL Y CONTROLES -->
        <section
            class="bg-card border border-border rounded-2xl p-8 md:p-12 shadow-2xl flex flex-col items-center relative">

            <!-- EL BOMBO / CORAZÓN VISUAL -->
            <div class="h-48 flex items-center justify-center mb-8 w-full">
                <div id="corazon-visual"
                    class="w-32 h-32 md:w-40 md:h-40 rounded-full bg-gradient-to-br from-[#2a1310] to-[#120806] border-4 border-terracotta shadow-[0_0_20px_rgba(234,88,12,0.2)] flex items-center justify-center transition-transform cursor-pointer relative">
                    <div class="absolute inset-0 rounded-full border border-terracotta/30 scale-110"></div>
                    <i class="ph-fill ph-heartbeat text-5xl md:text-6xl text-terracotta"></i>
                </div>
            </div>

            <!-- CONTROLES -->
            <div class="w-full max-w-md space-y-8">

                <!-- PLAY / PAUSE -->
                <div class="flex justify-center">
                    <button id="btn-play"
                        class="w-20 h-20 rounded-full bg-amber text-base font-bold flex items-center justify-center text-4xl shadow-[0_0_20px_rgba(251,191,36,0.3)] hover:scale-105 hover:bg-yellow-400 hover:shadow-[0_0_30px_rgba(251,191,36,0.5)] transition-all duration-200">
                        <i id="icono-play" class="ph-fill ph-play ml-2"></i>
                    </button>
                </div>

                <!-- SLIDER BPM -->
                <div class="space-y-4">
                    <div class="flex justify-between items-end">
                        <label for="bpm-slider" class="text-lg font-semibold text-white tracking-wide">Velocidad
                            (BPM)</label>
                        <span id="bpm-display-number" class="text-2xl font-bold text-amber font-mono">60</span>
                    </div>

                    <input type="range" id="bpm-slider" min="40" max="160" value="60" step="1">

                    <div class="text-center pt-2">
                        <p id="bpm-descripcion" class="text-textMuted text-sm italic">60 BPM - Lento como un latido en
                            reposo</p>
                    </div>
                </div>

            </div>

        </section>

    </main>

    <!-- MOTOR DE AUDIO Y LÓGICA -->
    <script>
        // Variables UI
        const btnPlay = document.getElementById('btn-play');
        const iconoPlay = document.getElementById('icono-play');
        const sliderBPM = document.getElementById('bpm-slider');
        const displayNumber = document.getElementById('bpm-display-number');
        const descText = document.getElementById('bpm-descripcion');
        const corazonVisual = document.getElementById('corazon-visual');

        // Estado del Motor
        let isPlaying = false;
        let bpm = 60;
        let audioContext = null;
        let nextNoteTime = 0.0;
        let timerID = null;
        const lookahead = 25.0; // ms
        const scheduleAheadTime = 0.1; // s

        // Inicializar AudioContext en interacción del usuario para evitar bloqueos del navegador
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        // Descripciones dinámicas según BPM
        function actualizarDescripcion(valor) {
            let texto = "";
            if (valor < 60) texto = "Muy lento - Sensación pesada o de marcha lenta";
            else if (valor < 80) texto = "Lento como un latido en reposo";
            else if (valor < 100) texto = "Medio - Caminar a paso tranquilo";
            else if (valor < 120) texto = "Alegre - Un trote ligero o baile suave";
            else if (valor < 140) texto = "Rápido - Energía alta, chacarera animada";
            else texto = "Muy rápido - Frenético, mucha intensidad";

            descText.textContent = `${valor} BPM - ${texto}`;
        }

        // Sintetizar sonido del bombo (latido)
        function playLatido(time) {
            // Oscilador para la frecuencia base grave
            const osc = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            osc.connect(gainNode);
            gainNode.connect(audioContext.destination);

            // Tono grave tipo bombo de legüero / latido (100Hz bajando a 50Hz)
            osc.frequency.setValueAtTime(120, time);
            osc.frequency.exponentialRampToValueAtTime(50, time + 0.1);

            // Envolvente de volumen (ataque rápido, decaimiento rápido)
            gainNode.gain.setValueAtTime(0, time);
            gainNode.gain.linearRampToValueAtTime(1, time + 0.01);
            gainNode.gain.exponentialRampToValueAtTime(0.001, time + 0.2);

            osc.start(time);
            osc.stop(time + 0.2);

            // Programar la animación visual para que ocurra exactamente en este 'time'
            const timeToWait = (time - audioContext.currentTime) * 1000;
            setTimeout(animarLatido, Math.max(0, timeToWait));
        }

        // Animación visual sincronizada
        function animarLatido() {
            // Reiniciar animación quitando y volviendo a poner la clase
            corazonVisual.classList.remove('animate-pulse-beat');
            void corazonVisual.offsetWidth; // Trigger reflow
            corazonVisual.classList.add('animate-pulse-beat');
        }

        // Lógica de programación (Scheduler)
        function nextNote() {
            const secondsPerBeat = 60.0 / bpm;
            nextNoteTime += secondsPerBeat;
        }

        function scheduler() {
            // Mientras haya notas que deban tocarse antes del tiempo de scheduleAheadTime
            while (nextNoteTime < audioContext.currentTime + scheduleAheadTime) {
                playLatido(nextNoteTime);
                nextNote();
            }
            timerID = window.setTimeout(scheduler, lookahead);
        }

        // Eventos
        btnPlay.addEventListener('click', () => {
            initAudio();

            isPlaying = !isPlaying;

            if (isPlaying) {
                iconoPlay.classList.replace('ph-play', 'ph-pause');
                iconoPlay.classList.remove('ml-2');

                // Empezar el scheduler
                nextNoteTime = audioContext.currentTime + 0.05;
                scheduler();
            } else {
                iconoPlay.classList.replace('ph-pause', 'ph-play');
                iconoPlay.classList.add('ml-2');

                // Detener el scheduler
                window.clearTimeout(timerID);
            }
        });

        sliderBPM.addEventListener('input', (e) => {
            bpm = parseInt(e.target.value);
            displayNumber.textContent = bpm;
            actualizarDescripcion(bpm);
        });

        // Click directo en el corazón
        corazonVisual.addEventListener('click', () => {
            initAudio();
            playLatido(audioContext.currentTime);
        });

        // Inicializar texto
        actualizarDescripcion(bpm);

    </script>
</body>

</html>